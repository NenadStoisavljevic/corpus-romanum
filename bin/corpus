#!/bin/sh

# Requires Whitacker's Words (Latin-English dictionary), you can
# find it at https://github.com/mk270/whitakers-words.

corpusdir="${XDG_DATA_HOME:-$HOME/.local/share}/corpus"
website="thelatinlibrary.com"

! mkdir -p "$corpusdir" && echo "Do you have write access in this directory?" && exit 1

# A list of substitutes for the parts of speech.
subs="ADJ:A
ADV:D
CONJ:C
INTERJ:I
NUM:M
PREP:P
PRON:O
SUFFIX:S
SUPINE:U
TACKON:T
VPAR:R"

getlatin() { echo "Enter the full link of the text:"
	read -r link
	domain="$(echo "$link" | cut -d '/' -f3)"
	[ "$domain" != "$website" ] && echo "Not a valid URL, check http://thelatinlibrary.com for Latin texts." && exit 1

	echo "Enter the name of the text:"
	read -r name
	getfiles; for x in $(seq 1 99); do echo "$files" | grep -q "^$x)" || { export id=$x; break ;}; done
	name="$(echo "$name" | iconv -cf UTF-8 -t ASCII//TRANSLIT | tr -d '[:punct:]' | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | sed "s/-\+/-/g;s/\(^-\|-\$\)//g")"
	file="$corpusdir/$id-$name"

	curl -sf "$link" > "$file" || exit 1
	sed -i 's/<[^>]*>//g
	s/&nbsp;//g
	s/\t//g
	/./,/^$/!d
	s/  \+/ /g' "$file"
}

sub() { for x in $1; do
		letter=$(echo "$subs" | grep -w "$x" | cut -d ':' -f2)
		[ -z "$letter" ] && labels="${labels}$x" || labels="${labels}$letter"
	done; printf "%s\n" "$labels"
}

tagfile() { [ ! -e "$1" ] && echo "\"$1\" is not a valid file." && return 1
	if [ -n "$id" ]; then
		file="$(basename "$1" | sed "s/[0-9]\{1,\}-//")"; id=$((id+1))
		output="$corpusdir/$id-$file-tagged" && echo "Tagging \"$file\"..."
	else
		output="$1-tagged" && echo "Tagging \"$1\"..."
	fi
	while read -r line; do
		[ -z "$line" ] && printf "\n" >> "$output" || last=${line##* } && total=$(echo "$line" | grep -ow "$last" | wc -w) && count=0
		for word in $line; do
			[ "$word" = "$last" ] && count=$((count+1))

			pos=$(words "$word" | grep -Ev '(;|])' | awk '$2~/[A-Z]$/{print $2}' | sort -u)
			letters=$(sub "$pos")

			if [ "$total" = "$count" ] && [ -z "$letters" ]; then
				printf "%s\n" "$word" >> "$output"
			elif [ "$total" = "$count" ]; then
				printf "%s//%s\n" "$word" "$letters" >> "$output"
			elif [ -z "$letters" ]; then
				printf "%s " "$word" >> "$output"
			else
				printf "%s//%s " "$word" "$letters" >> "$output"
			fi
		done
	done < "$1"
}

tagword() { for word in $1; do
		pos=$(words "$word" | grep -Ev '(;|])' | awk '$2~/[A-Z]/{print $2}' | sort -u)
		letters=$(sub "$pos")
		if [ -z "$letters" ]; then
			echo "$word is not a valid word."
		else
			printf "%s//%s\n" "$word" "$letters"
		fi
	done
}

check() { output="$1-tagged"
	if [ -e "$output" ]; then
		echo "The tagged file already exists, would you like to remove it? [yN]"
		read -r choice
		echo "$choice" | grep -iq "^y$" &&
			rm -f "$output" || exit 1
	fi
}

delete() { echo "Choose the file you would like to delete (by number):" && list
	read -r input
	chosen="^$input-"
	stored="$(find "$corpusdir" -type f -printf "%f\n" | grep "$chosen")"
	file="$(echo "$stored" | sed "s/^.-//")"; id=$((input+1))
	tagged="$(find "$corpusdir" -type f -printf "%f\n" | grep "$id-$file-tagged")"

	if [ -n "$stored" ] && [ -n "$tagged" ]; then
		echo "Would you like to remove the tagged file as well? [yN]"
		read -r choice
		echo "$choice" | grep -iq "^y$" &&
			rm -f "$corpusdir/$tagged" || echo "Skipping tagged file..."
		rm -f "$corpusdir/$stored"
	elif [ -n "$stored" ] && [ -z "$tagged" ]; then
		rm -f "$corpusdir/$stored"
	else
		echo "File does not exist, could not delete it."
	fi
}

search() { [ "$(ls -A "$corpusdir")" ] || echo "Corpus is empty, run with -c to add Latin texts."
	echo "Searching corpus..."
	du -a "$corpusdir"/* | awk '{print $2}' | fzf --delimiter / --with-nth -1 | xargs -r less
}

getfiles() { files=$(find "$corpusdir" -type f -printf "%f\n" | grep -o "[0-9]\{1,\}-.*" | sed "s/-/) /" | sort -n) ;}

list() { getfiles && [ -n "$files" ] && echo "$files" || exit 1 ;}

setopus() { if [ -n "${opus+x}" ] && [ "$opus" != "$1" ]; then
		echo "Running $1 with $opus..."
		echo "Incompatible options given. Only one action may be specified per run."
		return 1
	else
		opus="$1"
	fi
}

corpusinfo() { cat << EOF
corpus: grammatical tagger for Latin text documents

Main options:
  -t	Tag file
  -w	Tag word(s) (recommended to be in double quotes)
  -c	Download Latin text from The Latin Library
  -s	Search for any file from the corpus
  -l	List files stored in the corpus
  -d	Remove file from corpus
EOF
}

while getopts "csldt:w:" o; do case "${o}" in
	l) setopus list || exit 1 ;;
	t) setopus tagfile || exit 1; file="$OPTARG" ;;
	w) setopus tagword || exit 1; word="$OPTARG" ;;
	c) setopus add || exit 1 ;;
	s) setopus search || exit 1 ;;
	d) setopus delete || exit 1 ;;
	*) corpusinfo; exit 1 ;;
esac done

case "$opus" in
	list) list ;;
	tagfile) check "$file" && tagfile "$file" ;;
	tagword) tagword "$word" ;;
	add) getlatin && tagfile "$file" ;;
	search) search ;;
	delete) delete ;;
	*) corpusinfo; exit 1 ;;
esac
